name: Build Multi-Platform Docker Images with Triple Tags

on:
  # 1. æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆé¿å…é‡å¤æ„å»ºï¼‰
  push:
    branches:
      - main        # åªåœ¨æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶æ„å»º
      
  # 2. Pull Request æ—¶è§¦å‘ï¼ˆä»…æ„å»ºæµ‹è¯•ï¼Œä¸æ¨é€ï¼‰
  pull_request:
    branches:
      - main
      
  # 3. æ‰‹åŠ¨è§¦å‘ï¼ˆå¯é€‰è‡ªå®šä¹‰ç‰ˆæœ¬å·ï¼‰
  workflow_dispatch:
    inputs:
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (æ”¯æŒ v å‰ç¼€ï¼Œå¦‚: v3.2.19 æˆ– 3.2.19, ç•™ç©ºåˆ™è‡ªåŠ¨æ£€æµ‹)'
        required: false
        default: ''
        type: string
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE_NAME: qiqiandfei/115-bot  # æ›¿æ¢ä¸ºæ‚¨çš„Docker Hubç”¨æˆ·å/ä»“åº“å

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version from commit or tag
        id: version
        run: |
          # è®¾ç½®åŸºç¡€ä¿¡æ¯
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=${GITHUB_SHA::7}
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          
          echo "ğŸ” Analyzing version sources..."
          echo "ğŸ“ Commit message: ${COMMIT_MSG}"
          echo "ğŸ”— GitHub ref: ${GITHUB_REF}"
          
          # 0. ä¼˜å…ˆçº§0: ä» update.md è¯»å–ç‰ˆæœ¬ (ä½œä¸º Release çš„æ¥æº)
          if [[ -f "update.md" ]]; then
             # æå–ç‰ˆæœ¬å·: æŸ¥æ‰¾ vX.Y.Z æ ¼å¼
             FILE_VERSION=$(grep -oE "v[0-9]+\.[0-9]+\.[0-9]+" update.md | head -n1)
             if [[ -n "$FILE_VERSION" ]]; then
               echo "ğŸ“„ Found version in update.md: $FILE_VERSION"
               echo "file_version=${FILE_VERSION}" >> $GITHUB_OUTPUT
             fi
          fi

          # 1. ä¼˜å…ˆçº§1: æ‰‹åŠ¨è§¦å‘çš„è‡ªå®šä¹‰ç‰ˆæœ¬
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.custom_version }}" ]]; then
            VERSION="${{ github.event.inputs.custom_version }}"
            # å¦‚æœæ‰‹åŠ¨è¾“å…¥æ²¡æœ‰ v å‰ç¼€ä¸”æ˜¯ç‰ˆæœ¬å·æ ¼å¼ï¼Œè‡ªåŠ¨æ·»åŠ  v å‰ç¼€
            if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              VERSION="v${VERSION}"
            fi
            VERSION_SOURCE="manual_input"
            echo "âœ… Using manual input version: ${VERSION}"
            
          # 2. ä¼˜å…ˆçº§2: Git æ ‡ç­¾ï¼ˆå¦‚ v3.2.19ï¼‰
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            # ä¿ç•™ v å‰ç¼€ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ 
            if [[ ! "$VERSION" =~ ^v ]]; then
              VERSION="v${VERSION}"
            fi
            VERSION_SOURCE="git_tag"
            echo "âœ… Using git tag version: ${VERSION}"
            
          # 3. ä¼˜å…ˆçº§3: ä½¿ç”¨ update.md ä¸­çš„ç‰ˆæœ¬ (å¦‚æœå­˜åœ¨)
          elif [[ -n "$FILE_VERSION" ]]; then
            VERSION="$FILE_VERSION"
            VERSION_SOURCE="update_md"
            echo "âœ… Using version from update.md: ${VERSION}"

          # 4. ä¼˜å…ˆçº§4: ä» commit æ¶ˆæ¯ä¸­æå–ç‰ˆæœ¬å·ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
          elif echo "${COMMIT_MSG}" | grep -qE "(v?[0-9]+\.[0-9]+\.[0-9]+)"; then
            # æå–ç‰ˆæœ¬å·: æ”¯æŒ v3.2.19, 3.2.19, version 3.2.19 ç­‰æ ¼å¼
            VERSION=$(echo "${COMMIT_MSG}" | grep -oE "(v?[0-9]+\.[0-9]+\.[0-9]+)" | head -n1)
            # ç¡®ä¿æœ‰ v å‰ç¼€
            if [[ ! "$VERSION" =~ ^v ]]; then
              VERSION="v${VERSION}"
            fi
            VERSION_SOURCE="commit_message"
            echo "âœ… Extracted version from commit message: ${VERSION}"
            
          # 5. ä¼˜å…ˆçº§5: æŸ¥æ‰¾æœ€è¿‘çš„ git æ ‡ç­¾
          elif git describe --tags --abbrev=0 2>/dev/null; then
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
            # ä¿ç•™åŸå§‹æ ‡ç­¾æ ¼å¼ï¼Œä½†ç¡®ä¿æœ‰ v å‰ç¼€
            if [[ ! "$LATEST_TAG" =~ ^v ]]; then
              LATEST_TAG="v${LATEST_TAG}"
            fi
            VERSION="$LATEST_TAG"
            # å¦‚æœä¸æ˜¯å½“å‰æäº¤çš„æ ‡ç­¾ï¼Œæ·»åŠ åç¼€
            if [[ "$(git rev-list -n 1 ${LATEST_TAG})" != "${GITHUB_SHA}" ]]; then
              VERSION="${VERSION}-${SHORT_SHA}"
            fi
            VERSION_SOURCE="latest_git_tag"
            echo "âœ… Using latest git tag: ${VERSION}"
            
          # 6. é»˜è®¤: ç”ŸæˆåŸºäºæ—¶é—´æˆ³çš„ç‰ˆæœ¬
          else
            if [[ $GITHUB_REF == refs/heads/main ]]; then
              VERSION="${TIMESTAMP}-${SHORT_SHA}"
              VERSION_SOURCE="timestamp_main"
            elif [[ $GITHUB_REF == refs/heads/develop ]]; then
              VERSION="dev-${TIMESTAMP}-${SHORT_SHA}"
              VERSION_SOURCE="timestamp_dev"
            else
              BRANCH_NAME=${GITHUB_REF#refs/heads/}
              BRANCH_NAME=${BRANCH_NAME//\//-}
              VERSION="${BRANCH_NAME}-${TIMESTAMP}-${SHORT_SHA}"
              VERSION_SOURCE="timestamp_branch"
            fi
            echo "âš ï¸ No version found, generated: ${VERSION}"
          fi
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_source=${VERSION_SOURCE}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          
          # å¦‚æœä½¿ç”¨äº† update.md çš„ç‰ˆæœ¬ï¼Œè®¾ç½® release æ ‡è®°
          if [[ "$VERSION_SOURCE" == "update_md" ]]; then
             echo "should_release=true" >> $GITHUB_OUTPUT
          else
             echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "ğŸ“‹ Version Summary:"
          echo "ğŸ·ï¸ Final version: ${VERSION}"
          echo "ğŸ“ Source: ${VERSION_SOURCE}"
          echo "ğŸ“… Timestamp: ${TIMESTAMP}"
          echo "ğŸ” Short SHA: ${SHORT_SHA}"

      - name: Prepare tags
        id: tags
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR åªæ„å»ºæµ‹è¯•ï¼Œä½¿ç”¨ç‰¹æ®Šæ ‡ç­¾
            TAGS="${{ env.IMAGE_NAME }}:pr-${{ github.event.number }}"
            echo "ğŸ”„ PR build - Tag: pr-${{ github.event.number }}"
          else
            # æ­£å¸¸æ„å»º - åˆ›å»ºä¸‰ä¸ªæ ‡ç­¾
            TAGS="${{ env.IMAGE_NAME }}:latest"
            TAGS="${TAGS},${{ env.IMAGE_NAME }}:beta" 
            TAGS="${TAGS},${{ env.IMAGE_NAME }}:${VERSION}"
            
            echo "ğŸ·ï¸ Building with triple tags:"
            echo "   ğŸ“Œ latest"
            echo "   ğŸ§ª beta" 
            echo "   ğŸ”¢ ${VERSION}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Generate labels
        id: labels
        run: |
          LABELS="org.opencontainers.image.title=Telegram-115Bot"
          LABELS="${LABELS},org.opencontainers.image.description=A Telegram bot for 115 cloud storage management"
          LABELS="${LABELS},org.opencontainers.image.source=https://github.com/${{ github.repository }}"
          LABELS="${LABELS},org.opencontainers.image.version=${{ steps.version.outputs.version }}"
          LABELS="${LABELS},org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          LABELS="${LABELS},org.opencontainers.image.revision=${{ github.sha }}"
          LABELS="${LABELS},org.opencontainers.image.url=https://github.com/${{ github.repository }}"
          
          echo "labels=${LABELS}" >> $GITHUB_OUTPUT

      - name: Debug build info
        run: |
          echo "ğŸ” Build Debug Information:"
          echo "Event name: ${{ github.event_name }}"
          echo "Should push: ${{ github.event_name != 'pull_request' }}"
          echo "FORCE PUSH: true (debugging)"
          echo "Tags: ${{ steps.tags.outputs.tags }}"
          echo "Platforms: linux/amd64,linux/arm64"
          echo "Registry: ${{ env.REGISTRY }}"
          echo "Image name: ${{ env.IMAGE_NAME }}"
          
      - name: Verify Docker login
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ” Testing Docker Hub authentication..."
          docker info || echo "âš ï¸ Docker info failed"
          echo "âœ… Docker login appears successful"
          
      - name: Build and push Docker images
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          # ğŸš¨ å¼ºåˆ¶æ¨é€ï¼Œç¡®ä¿ä¸€å®šæ¨é€åˆ° Docker Hub
          push: true  # å¼ºåˆ¶æ¨é€ï¼Œä¸ç®¡è§¦å‘æ¡ä»¶
          tags: ${{ steps.tags.outputs.tags }}
          labels: ${{ steps.labels.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # æ·»åŠ æ„å»ºå‚æ•°ä»¥å¼ºåˆ¶åŒºåˆ†ä¸åŒæ„å»º
          build-args: |
            BUILDTIME=${{ steps.version.outputs.timestamp }}
          # æ·»åŠ è¯¦ç»†è¾“å‡º
          outputs: type=registry,push=true
          
      - name: Verify Docker Hub push success
        run: |
          echo "ğŸ” Verifying images were pushed to Docker Hub..."
          echo "ğŸ“‹ Expected tags: ${{ steps.tags.outputs.tags }}"
          
          # ç­‰å¾…å‡ ç§’è®© Docker Hub å¤„ç†
          sleep 10
          
          # æ£€æŸ¥æ¯ä¸ªæ ‡ç­¾
          for tag in $(echo "${{ steps.tags.outputs.tags }}" | tr ',' '\n'); do
            echo ""
            echo "ğŸ·ï¸ Checking tag: $tag"
            echo "----------------------------------------"
            
            # æ–¹æ³•1: ä½¿ç”¨ docker buildx imagetools inspect
            if docker buildx imagetools inspect $tag; then
              echo "âœ… Tag $tag exists and supports multi-platform"
            else
              echo "âŒ Failed to verify tag $tag"
            fi
            
            # æ–¹æ³•2: ä½¿ç”¨ Docker Hub API æ£€æŸ¥
            echo "ğŸŒ Checking via Docker Hub API..."
            IMAGE_NAME=$(echo $tag | cut -d':' -f1)
            TAG_NAME=$(echo $tag | cut -d':' -f2)
            API_URL="https://hub.docker.com/v2/repositories/${IMAGE_NAME}/tags/${TAG_NAME}/"
            
            if curl -f -s "$API_URL" > /dev/null; then
              echo "âœ… Tag $tag confirmed via API"
              # æ˜¾ç¤ºæ¶æ„ä¿¡æ¯
              curl -s "$API_URL" | jq -r '.images[]? | "  - \(.architecture)/\(.os)"' || echo "  - API response parsing failed"
            else
              echo "âŒ Tag $tag not found via API"
            fi
          done
          
          echo ""
          echo "ğŸ¯ æ¨é€éªŒè¯å®Œæˆï¼å¦‚æœçœ‹åˆ° âœ… è¯´æ˜æ¨é€æˆåŠŸ"
          
      - name: Build summary
        if: github.event_name != 'pull_request'
        run: |
          echo "## ğŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Built Images:" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:beta\`" >> $GITHUB_STEP_SUMMARY  
          echo "- \`${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ—ï¸ Build Info:" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Source:** ${{ steps.version.outputs.version_source }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch/Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA:** ${{ steps.version.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Usage:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Latest stable version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Beta version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_NAME }}:beta" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Specific version" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Release
        if: steps.version.outputs.should_release == 'true' && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "ğŸš€ Starting release process for version $VERSION..."
          
          # 1. æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "âš ï¸ Release $VERSION already exists. Skipping creation."
            echo "::warning::Release $VERSION already exists."
            exit 0
          fi
          
          # 2. å‡†å¤‡ Release Note
          # å»æ‰ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼Œä¿ç•™æ­£æ–‡
          tail -n +2 update.md > release_notes.md
          
          echo "ğŸ“ Release Notes:"
          cat release_notes.md
          
          # 3. åˆ›å»º Release
          # --target main: åŸºäº main åˆ†æ”¯
          # --title: æ ‡é¢˜ï¼Œé€šå¸¸æ˜¯ç‰ˆæœ¬å·
          # --notes-file: å†…å®¹æ–‡ä»¶
          echo "ğŸ“¦ Creating release $VERSION..."
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes-file release_notes.md \
            --target main
            
          echo "âœ… Release $VERSION created successfully!"
          echo "ğŸ”— $(gh release view "$VERSION" --json url -q .url)"
