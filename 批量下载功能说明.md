# 批量下载自动文件夹功能说明

## 功能概述

该功能增强了Telegram-115bot的批量下载能力,支持自动识别文本中的首行+尾行文字作为文件夹名,并提供灵活的批量移动功能。

## 主要功能

### 1. 自动文件夹名提取

当用户发送包含多个下载链接的文本时,系统会自动:
- 提取**首行非链接文字** + **尾行非链接文字**
- 清理不合法的文件夹字符
- 自动创建自定义文件夹并将所有下载内容保存到该文件夹

#### 示例输入:
```
miru(坂道みる/坂道美琉)原档合集:
ed2k://|file|www.98T.la@SONE-882.mp4|6458233593|97469A8B0C902283D99E6026E28843A3|/
ed2k://|file|www.98T.la@SONE-830.mp4|6467401273|5294F6CB34EA43DA9016A1FCD21B0DD0|/
20251007
```

#### 系统处理:
1. 识别首行: `miru(坂道みる/坂道美琉)原档合集:`
2. 识别尾行: `20251007`
3. 拼接: `miru(坂道みる/坂道美琉)原档合集:20251007`
4. 清理字符:
   - 移除 `:` 冒号
   - 替换 `/` 为 `-`
5. 最终文件夹名: `miru(坂道みる-坂道美琉)原档合集20251007`

### 2. 字符清理规则

为确保跨平台兼容性,系统会自动清理以下字符:

| 规则 | 说明 |
|------|------|
| 移除 `:` | 直接删除冒号 |
| 替换 `/` `\` `?` `*` `"` `<` `>` `\|` | 替换为 `-` |
| 去除前后空格 | 自动trim |

### 3. "移动到[]"批量移动功能

如果链接数量 > 1,在所有下载任务完成后,系统会提示用户可以使用批量移动功能:

```
✅ 批量下载完成！共 2/2 个任务成功

💡 如需批量移动文件，请回复：
移动到[自定义文件夹名]
```

#### 使用方式:
```
移动到[新建文件夹名]
```

#### 示例:
```
移动到[合集2025]
```

系统会:
1. 在当前下载路径下创建 `合集2025` 文件夹
2. 批量移动所有已下载的文件到该文件夹
3. 返回移动结果统计

## 技术实现细节

### 核心函数

1. **`extract_folder_name_from_text(message_text: str) -> str`**
   - 从文本中提取首行+尾行非链接文字
   - 过滤空行和纯链接行
   - 返回清理后的文件夹名

2. **`sanitize_folder_name(text: str) -> str`**
   - 清理文件夹名中的非法字符
   - 确保跨平台兼容性

3. **`download_tasks_batch(..., custom_folder_name="")`**
   - 批量下载核心逻辑
   - 当 `custom_folder_name` 存在且链接数>1时,自动创建自定义文件夹
   - 记录成功下载的资源,用于后续批量移动

4. **`handle_batch_move(update, context)`**
   - 处理 `移动到[文件夹名]` 命令
   - 批量移动已下载的文件到新文件夹

### 工作流程

```
用户发送多链接文本
      ↓
提取首行+尾行文字 → 清理字符 → 生成文件夹名
      ↓
用户选择保存分类
      ↓
创建自定义文件夹
      ↓
批量提交下载任务(到自定义文件夹)
      ↓
等待下载完成
      ↓
批量处理结果 → 记录成功下载的资源
      ↓
[可选] 提示用户使用"移动到"功能
      ↓
用户输入: 移动到[新文件夹名]
      ↓
批量移动文件到新文件夹
      ↓
返回移动结果
```

## 注意事项

1. **仅多链接触发**: 只有当链接数量 > 1 时,才会:
   - 自动创建自定义文件夹
   - 提供"移动到"功能提示

2. **文件夹名冲突**: 如果自定义文件夹已存在,115 API会自动处理(通常是追加到现有文件夹)

3. **移动记录有效期**: 批量下载记录会保存在内存中,重启bot后会丢失

4. **最新记录优先**: 如果有多个批量下载记录,系统会自动使用最新的一个

## 测试

运行测试脚本验证文件夹名提取逻辑:

```bash
python3 test_folder_extraction.py
```

预期输出:
```
提取的文件夹名: [miru(坂道みる-坂道美琉)原档合集20251007]
预期结果: [miru(坂道みる-坂道美琉)原档合集20251007]
测试通过: True
```

## 修改的文件

- [`app/handlers/download_handler.py`](app/handlers/download_handler.py) - 主要实现文件
  - 新增 `sanitize_folder_name()` 函数
  - 新增 `extract_folder_name_from_text()` 函数
  - 修改 `start_d_command()` - 提取并保存自定义文件夹名
  - 修改 `select_main_category()` - 传递自定义文件夹名
  - 修改 `select_sub_category()` - 传递自定义文件夹名
  - 修改 `download_tasks_batch()` - 创建自定义文件夹,记录下载结果,提示移动功能
  - 新增 `handle_batch_move()` - 处理批量移动命令
  - 修改 `handle_manual_rename()` - 路由到批量移动处理

- [`README.md`](README.md) - 更新功能完成状态
- [`test_folder_extraction.py`](test_folder_extraction.py) - 测试脚本

## 兼容性

✅ 向后兼容: 如果文本中没有可提取的文件夹名,或只有单个链接,系统会按原有逻辑运行,不会影响现有功能。
