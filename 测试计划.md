# 批量下载功能测试计划

## 测试场景

### 场景1: 自动创建文件夹（有首尾行文字）

**输入**:
```
miru(坂道みる/坂道美琉)原档合集
ed2k://|file|www.98T.la@SONE-882.mp4|6458233593|97469A8B0C902283D99E6026E28843A3|/
ed2k://|file|www.98T.la@SONE-830.mp4|6467401273|5294F6CB34EA43DA9016A1FCD21B0DD0|/
20251008
```

**预期行为**:
1. 系统提取文件夹名: `miru(坂道みる-坂道美琉)原档合集20251008`
2. 在用户选择的路径下自动创建该文件夹
3. 两个ed2k链接下载到该文件夹中
4. 每个文件被套入 `temp` 文件夹
5. 下载完成显示: `✅ [1/2] 电影[hhd800.com@SONE-882.mp4]离线下载完成!`（显示原始文件名）
6. 下载完成显示: `✅ [2/2] 电影[hhd800.com@sone00830hhb_60fps.mp4]离线下载完成!`
7. **不提示**"移动到"功能（因为已经有自定义文件夹了）

**最终文件结构**:
```
/115BotDownload/AdultVideo/Manual/
└── miru(坂道みる-坂道美琉)原档合集20251008/
    └── temp/
        ├── hhd800.com@SONE-882.mp4
        └── hhd800.com@sone00830hhb_60fps.mp4
```

---

### 场景2: 批量下载（无首尾行文字）+ 移动到功能

**输入**:
```
ed2k://|file|www.98T.la@SONE-882.mp4|6458233593|97469A8B0C902283D99E6026E28843A3|/
ed2k://|file|www.98T.la@SONE-830.mp4|6467401273|5294F6CB34EA43DA9016A1FCD21B0DD0|/
```

**预期行为**:
1. 系统无法提取文件夹名（没有非链接文字）
2. 直接下载到用户选择的路径
3. 两个文件分别下载并套入各自的 `temp` 文件夹或同一个 `temp` 文件夹
4. 下载完成后提示:
```
✅ 批量下载完成！共 2/2 个任务成功

💡 如需批量移动文件，请回复：
移动到[自定义文件夹名]
```

**后续操作 - 使用移动到功能**:

用户输入:
```
移动到[合集2025]
```

**预期行为**:
1. 在下载路径下创建 `合集2025` 文件夹
2. 将 `temp` 文件夹中的所有文件移动到 `合集2025`
3. 显示: `✅ 批量移动完成！成功: 2 个`

**最终文件结构**:
```
/115BotDownload/AdultVideo/Manual/
├── temp/  (空文件夹或被删除)
└── 合集2025/
    ├── hhd800.com@SONE-882.mp4
    └── hhd800.com@sone00830hhb_60fps.mp4
```

---

### 场景3: 单个下载链接

**输入**:
```
ed2k://|file|www.98T.la@SONE-882.mp4|6458233593|97469A8B0C902283D99E6026E28843A3|/
```

**预期行为**:
1. 下载单个文件
2. 下载完成后提示重命名（TMDB标准名称）
3. **不提示**"移动到"功能（只有一个文件）
4. 行为与之前版本保持一致

---

### 场景4: 特殊字符处理

**输入**:
```
测试/标题:包含*特殊?字符<>
ed2k://|file|test1.mp4|123|ABC|/
ed2k://|file|test2.mp4|456|DEF|/
结束|符号"测试
```

**预期文件夹名**: `测试-标题包含-特殊-字符--结束-符号-测试`

**字符替换规则**:
- `:` → 删除
- `/` `\` `?` `*` `"` `<` `>` `|` → `-`

---

### 场景5: 混合内容（文件+文件夹）

**输入**: 两个链接，一个下载后是文件，一个下载后是文件夹

**预期行为**:
- 文件被套入 `temp` 文件夹
- 文件夹保持原样
- `successful_downloads` 包含: `["temp", "文件夹名"]`
- 移动时正确处理两种类型

---

## 关键测试点

### ✅ 必须测试
1. 文件夹名提取和字符清理
2. 自动创建自定义文件夹
3. 批量下载到自定义文件夹
4. 显示原始文件名而非 `temp`
5. "移动到"功能正确处理 `temp` 文件夹
6. 去重逻辑避免重复移动

### ⚠️ 边界情况
1. 只有首行没有尾行
2. 只有尾行没有首行
3. 首尾行相同
4. 空文件夹名
5. 超长文件夹名
6. 全是特殊字符的文件夹名
7. 下载失败的情况

### 🔄 回归测试
1. 单个下载链接功能不受影响
2. 重命名功能正常工作
3. 订阅功能不受影响
4. Emby扫库通知正常

---

## 调试检查点

### 日志关键词
```
提取到自定义文件夹名: [文件夹名]
创建自定义文件夹: [路径]
temp文件夹包含 N 个文件
移动文件: [文件名] -> [目标路径]
```

### 预期日志流程
1. `从输入中提取到 N 个有效下载链接`
2. `提取到自定义文件夹名: [名称]` (如果有)
3. `创建自定义文件夹: [路径]` (如果有)
4. `[1/N] 提交离线任务: ...`
5. `[1/N] [文件名] 离线下载成功！`
6. `[1/N] [文件名] 开始处理下载结果`
7. `目录创建成功: temp` 或 `目录已存在: temp`
8. `文件移动成功: ... -> .../temp`
9. `✅ [1/N] 电影[原始文件名]离线下载完成!` (注意显示原始名而非temp)
10. `批量下载任务处理完成，共 N 个任务`

---

## 已知限制

1. **内存存储**: 批量下载记录存储在内存中，bot重启后丢失
2. **temp文件夹**: 多个文件共享同一个 `temp` 文件夹，无法区分不同批次
3. **并发问题**: 如果用户同时发起多个批量下载，可能会混淆
4. **文件夹冲突**: 如果自定义文件夹已存在，行为取决于115 API

---

## 改进建议

1. 将批量下载记录持久化到数据库
2. 使用时间戳或唯一ID命名temp文件夹（如 `temp_20251008_214433`）
3. 添加批量下载状态追踪UI
4. 支持取消批量下载
5. 支持重试失败的单个任务
